<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="google" content="translate">
  <meta name="description" content="Sua calculadora financeira pr√°tica">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
  <link rel="stylesheet" href="style.css">
  <title>Chatbot financeiro</title>
</head>

<body>
  <div class="navigation">
    <nav>
      <div class="nav-wrapper">
        <button id="backButton" class="btn btn-default">Voltar</button>
        <span class="brand-logo center">Assistente</span>
        <button id="nextButton" class="btn btn-default">Pr√≥ximo</button>
      </div>
    </nav>
  </div>
  <div class="container">
    <div class="card">
      <div class="card-content">
        <div id="chatLog"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-content">
        <input type="text" id="userInput" placeholder="Fa√ßa sua pergunta">
        <button id="bot-button" class="btn btn-default">Enviar</button>
      </div>
    </div>
  </div>

  <!-- Importar Firebase -->
  <script type="module">

    const urlParams = new URLSearchParams(window.location.search);
    const currentYear = urlParams.get('year');

    import { displayYearInTitle } from './utils.js';
    displayYearInTitle();

    // Importa os m√≥dulos necess√°rios do Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
    import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js';
    import firebaseConfig from './config.js';

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Vari√°vel para armazenar o usu√°rio autenticado
    let user = null; // Declare user aqui

    // Verifica√ß√£o do estado de autentica√ß√£o
    onAuthStateChanged(auth, (currentUser) => {
      if (currentUser) {
        console.log("Usu√°rio autenticado:", currentUser.uid);
        user = currentUser;
        loadDataFromDatabase(currentUser.uid);
        loadCreditCardBalance(currentUser.uid);
        loadInitialBalance(currentUser.uid);
        // Exibe a mensagem de sauda√ß√£o ao carregar a p√°gina
        displayBotMessage("Ol√°! üëã  Eu sou seu assistente financeiro. Posso te ajudar a verificar suas informa√ß√µes financeiras. Por exemplo: para saber o seu saldo inicial de Janeiro, me pergunte Qual √© o meu saldo inicial de janeiro? Voc√™ pode saber sobre o saldo inicial, saldo final, valor da fatura do cart√£o de cr√©dito... Lembre-se sempre de especificar o M√™s que vc quer a informa√ß√£o. Como posso te ajudar hoje?");
      } else {
        window.location.href = "login.html";
      }
    });

    // Vari√°veis para armazenar os dados financeiros
    let januaryData = {};
    let februaryData = {};
    let marchData = {};
    let aprilData = {};
    let mayData = {};
    let juneData = {};
    let julyData = {};
    let augustData = {};
    let septemberData = {};
    let octoberData = {};
    let novemberData = {};
    let decemberData = {};

    // Carregar os dados financeiros do Firebase
    function loadDataFromDatabase(userId) {
      let currentYear = new URLSearchParams(window.location.search).get('year');
      const databaseRef = ref(database, `users/${userId}`);
      onValue(databaseRef, (snapshot) => {
        const userData = snapshot.val(); // Objeto JavaScript direto do Firebase
        if (userData) {
          januaryData = userData['january-' + currentYear] || {};
          februaryData = userData['february-' + currentYear] || {};
          marchData = userData['march-' + currentYear] || {};
          aprilData = userData['april-' + currentYear] || {};
          mayData = userData['may-' + currentYear] || {};
          juneData = userData['june-' + currentYear] || {};
          julyData = userData['july-' + currentYear] || {};
          augustData = userData['august-' + currentYear] || {};
          septemberData = userData['september-' + currentYear] || {};
          octoberData = userData['october-' + currentYear] || {};
          novemberData = userData['november-' + currentYear] || {};
          decemberData = userData['december-' + currentYear] || {};
        }
      });
    }

    // Carregar o saldo do cart√£o de cr√©dito do Firebase
    function loadCreditCardBalance(userId) {
      let currentYear = new URLSearchParams(window.location.search).get('year');
      const balanceRef = ref(database, `creditCardBalances/${userId}/${currentYear}`);
      onValue(balanceRef, (snapshot) => {
        const data = snapshot.val(); // Objeto JavaScript direto do Firebase
        if (data) {
          januaryData.creditCardBalance = data.januaryCreditCardBalance || 0.00;
          februaryData.creditCardBalance = data.februaryCreditCardBalance || 0.00;
          marchData.creditCardBalance = data.marchCreditCardBalance || 0.00;
          aprilData.creditCardBalance = data.aprilCreditCardBalance || 0.00;
          mayData.creditCardBalance = data.mayCreditCardBalance || 0.00;
          juneData.creditCardBalance = data.juneCreditCardBalance || 0.00;
          julyData.creditCardBalance = data.julyCreditCardBalance || 0.00;
          augustData.creditCardBalance = data.augustCreditCardBalance || 0.00;
          septemberData.creditCardBalance = data.septemberCreditCardBalance || 0.00;
          octoberData.creditCardBalance = data.octoberCreditCardBalance || 0.00;
          novemberData.creditCardBalance = data.novemberCreditCardBalance || 0.00;
          decemberData.creditCardBalance = data.decemberCreditCardBalance || 0.00;
        }
      });
    }

    // Carregar o saldo inicial do Firebase
    function loadInitialBalance(userId) {
      const balanceRef = ref(database, `initialBalances/${userId}`);
      onValue(balanceRef, (snapshot) => {
        const data = snapshot.val(); // Objeto JavaScript direto do Firebase
        if (data) {
          januaryData.initialBalance = data.JanInitialBalance || 0.00;
          februaryData.initialBalance = data.FebInitialBalance || 0.00;
          marchData.initialBalance = data.MarInitialBalance || 0.00;
          aprilData.initialBalance = data.AprInitialBalance || 0.00;
          mayData.initialBalance = data.MayInitialBalance || 0.00;
          juneData.initialBalance = data.JunInitialBalance || 0.00;
          julyData.initialBalance = data.JulInitialBalance || 0.00;
          augustData.initialBalance = data.AugInitialBalance || 0.00;
          septemberData.initialBalance = data.SepInitialBalance || 0.00;
          octoberData.initialBalance = data.OctInitialBalance || 0.00;
          novemberData.initialBalance = data.NovInitialBalance || 0.00;
          decemberData.initialBalance = data.DecInitialBalance || 0.00;
        }
      });
    }

    // Interface de usu√°rio do Chatbot
    const chatLog = document.getElementById('chatLog');
    const userInput = document.getElementById('userInput');

    // Fun√ß√£o para enviar a mensagem
    function sendMessage() {
      const message = userInput.value.trim();
      if (message !== "") {
        chatLog.innerHTML += `<div class="user-message"><strong>Voc√™:</strong> ${message}</div>`;

        // Chama processMessageAsync() que lida com a l√≥gica de forma ass√≠ncrona
        processMessageAsync(message);

        userInput.value = "";
      }
    }

    // Fun√ß√£o processMessageAsync para lidar com a l√≥gica de forma ass√≠ncrona
    async function processMessageAsync(message) {
      // Espera at√© que os dados do Firebase estejam carregados
      await waitForData();

      let response = "";
      message = message.toLowerCase().trim();

      // Palavras-chave para perguntas
      const palavrasChave = {
        saldoFinal: ["saldo final"],
        saldoInicial: ["saldo inicial"],
        dizimo: ["dizimo", "d√≠zimo"],
        cartaoCredito: ["cart√£o", "cartao", "fatura"],
        totalCredito: ["total de cr√©dito", "total de credito", "total cr√©dito", "total credito"],
        totalDebito: ["total de d√©bito", "total de debito", "total d√©bito", "total debito"],
        balanco: ["balan√ßo"],
        percentual: ["percentual", "porcentagem", "porcento", "percento"],
        saudacao: ["ol√°", "ola", "oi", "tudo bem"],
        duvida: ["informacao", "informacoes", "informa√ß√£o", "informa√ß√µes", "d√∫vida", "duvida", "ajuda", "help", "pergunta"]
      };

      // Verificar se a mensagem cont√©m uma palavra-chave
      for (const chave in palavrasChave) {
        if (palavrasChave[chave].some(keyword => message.includes(keyword))) {
          // Encontrou uma palavra-chave
          if (chave == "saudacao") {
            response = 'Oi! Qual informa√ß√£o financeira voc√™ quer saber? N√£o esque√ßa de especificar o m√™s.';
          } if (chave == "duvida") {
            response = 'Voc√™ pode obter o valor do seu Saldo Final, Saldo Inicial, D√≠zimo, Fatura do Cart√£o de Cr√©dito, Total de Cr√©dito, Total de D√©bito, Balan√ßo em moeda e em Porcentagem do m√™s que voc√™ especificar na mensagem. Apenas me pergunte. Por exemplo: Me diga qual √© o valor da minha fatura do cart√£o de cr√©dito do m√™s de novembro.';
          } else if (chave === "saldoFinal") {
            // Buscar m√™s na pergunta
            const month = message.match(/janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro/i);
            if (month) {
              const monthData = getMonthData(month[0].toLowerCase());
              if (monthData && monthData.finalBalance) {
                response = `O saldo final de ${month[0]} √© ${monthData.finalBalance}.`;
              } else {
                response = `N√£o encontrei dados para ${month[0]}.`;
              }
            } else {
              response = `Por favor, especifique o m√™s.`;
            }
          } else if (chave === "dizimo") {
            // Buscar m√™s na pergunta
            const month = message.match(/janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro/i);
            if (month) {
              const monthData = getMonthData(month[0].toLowerCase());
              if (monthData && monthData.tithe) {
                response = `O d√≠zimo de ${month[0]} √© ${monthData.tithe}.`;
              } else {
                response = `N√£o encontrei dados para ${month[0]}.`;
              }
            } else {
              response = `Por favor, especifique o m√™s.`;
            }
          } else if (chave === "saldoInicial") {
            // Buscar m√™s na pergunta
            const month = message.match(/janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro/i);
            if (month) {
              const monthData = getMonthData(month[0].toLowerCase());
              if (monthData && monthData.initialBalance) {
                response = `O saldo inicial de ${month[0]} √© ${monthData.initialBalance}.`;
              } else {
                // Se o saldo inicial n√£o estiver dispon√≠vel, procure o saldo final do m√™s anterior
                const previousMonth = getPreviousMonth(month[0].toLowerCase());
                if (previousMonth) {
                  const previousMonthData = getMonthData(previousMonth);
                  if (previousMonthData && previousMonthData.finalBalance) {
                    response = `O saldo inicial de ${month[0]} √© ${previousMonthData.finalBalance}, que √© o saldo final de ${previousMonth}.`;
                  } else {
                    response = `N√£o encontrei dados para o saldo inicial de ${month[0]}.`;
                  }
                } else {
                  response = `N√£o encontrei dados para o saldo inicial de ${month[0]}.`;
                }
              }
            } else {
              response = `Por favor, especifique o m√™s.`;
            }
          } else if (chave === "cartaoCredito") {
            // Buscar m√™s na pergunta
            const month = message.match(/janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro/i);
            if (month) {
              const monthData = getMonthData(month[0].toLowerCase());
              if (monthData && monthData.creditCardBalance) {
                response = `O fatura do cart√£o de cr√©dito em ${month[0]} foi de ${monthData.creditCardBalance}.`;
              } else {
                response = `N√£o encontrei dados para ${month[0]}.`;
              }
            } else {
              response = `Por favor, especifique o m√™s.`;
            }
          } else if (chave === "totalCredito") {
            // Buscar m√™s na pergunta
            const month = message.match(/janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro/i);
            if (month) {
              const monthData = getMonthData(month[0].toLowerCase());
              if (monthData && monthData.totalCredit) {
                response = `O total de cr√©dito em ${month[0]} √© ${monthData.totalCredit}.`;
              } else {
                response = `N√£o encontrei dados para ${month[0]}.`;
              }
            } else {
              response = `Por favor, especifique o m√™s.`;
            }
          } else if (chave === "totalDebito") {
            // Buscar m√™s na pergunta
            const month = message.match(/janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro/i);
            if (month) {
              const monthData = getMonthData(month[0].toLowerCase());
              if (monthData && monthData.totalDebit) {
                response = `O total de d√©bito em ${month[0]} √© ${monthData.totalDebit}.`;
              } else {
                response = `N√£o encontrei dados para ${month[0]}.`;
              }
            } else {
              response = `Por favor, especifique o m√™s.`;
            }
          } else if (chave === "balanco") {
            // Buscar m√™s na pergunta
            const month = message.match(/janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro/i);
            if (month) {
              const monthData = getMonthData(month[0].toLowerCase());
              if (monthData && monthData.balance) {
                response = `O balan√ßo em ${month[0]} √© ${monthData.balance}. O balan√ßo representa a diferen√ßa entre o cr√©dito e o d√©bito, ou seja, se este valor for um valor negativo sifnifica que voc√™ gastou mais do que ganhou. Para saber quanto foi o seu balan√ßo em porcentagem, pergunte (Qual foi a porcentagem das minhas transa√ß√µes para ${month[0]})`;
              } else {
                response = `N√£o encontrei dados para ${month[0]}.`;
              }
            } else {
              response = `Por favor, especifique o m√™s.`;
            }
          } else if (chave === "percentual") {
            // Buscar m√™s na pergunta
            const month = message.match(/janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro/i);
            if (month) {
              const monthData = getMonthData(month[0].toLowerCase());
              if (monthData && monthData.percentage) {
                const percentage = parseFloat(monthData.percentage); // Converte a string para n√∫mero
                if (percentage > 100) {
                  const balance = Math.abs(parseFloat(monthData.balance)); // Remove o sinal negativo
                  response = `O percentual de d√©bito em rela√ß√£o ao cr√©dito em ${month[0]} √© ${monthData.percentage}, ou seja, voc√™ gastou ${balance.toFixed(2)} a mais do que ganhou. Cuidado com gastos excessivos. Que tal checar o saldo final de ${month[0]} para saber se voc√™ ficou no vermelho? Para isso digite qual o saldo final de ${month[0]}`;
                } else if (percentage < 100) {
                  response = `O percentual de d√©bito em rela√ß√£o ao cr√©dito em ${month[0]} √© ${monthData.percentage}, ou seja, voc√™ recebeu ${monthData.balance} a mais do que gastou. Parab√©ns! Voc√™ est√° fazendo um bom trabalho de economia.`;
                } else {
                  response = `O percentual de d√©bito em rela√ß√£o ao cr√©dito em ${month[0]} √© ${monthData.percentage}.`;
                }
              } else {
                response = `N√£o encontrei dados para ${month[0]}.`;
              }
            } else {
              response = `Por favor, especifique o m√™s.`;
            }
          }
          break; // Encontrou uma palavra-chave, parar de verificar as outras
        }
      }

      // Se nenhuma palavra-chave foi encontrada
      if (response === "") {
        response = `Desculpe, n√£o entendi sua pergunta.`;
      }

      chatLog.innerHTML += `<div class="bot-message"><strong>Assistente:</strong> ${response}</div>`;
    }

    // Fun√ß√£o para obter os dados do m√™s
    function getMonthData(month) {
      let currentYear = new URLSearchParams(window.location.search).get('year');
      switch (month) {
        case "janeiro":
          return januaryData;
        case "fevereiro":
          return februaryData;
        case "mar√ßo":
          return marchData;
        case "abril":
          return aprilData;
        case "maio":
          return mayData;
        case "junho":
          return juneData;
        case "julho":
          return julyData;
        case "agosto":
          return augustData;
        case "setembro":
          return septemberData;
        case "outubro":
          return octoberData;
        case "novembro":
          return novemberData;
        case "dezembro":
          return decemberData;
        default:
          return null;
      }
    }

    // Fun√ß√£o para obter o m√™s anterior
    function getPreviousMonth(month) {
      switch (month) {
        case "fevereiro":
          return "janeiro";
        case "mar√ßo":
          return "fevereiro";
        case "abril":
          return "mar√ßo";
        case "maio":
          return "abril";
        case "junho":
          return "maio";
        case "julho":
          return "junho";
        case "agosto":
          return "julho";
        case "setembro":
          return "agosto";
        case "outubro":
          return "setembro";
        case "novembro":
          return "outubro";
        case "dezembro":
          return "novembro";
        default:
          return null;
      }
    }

    // Fun√ß√£o para aguardar o carregamento dos dados do Firebase
    async function waitForData() {
      // Cria uma promessa que ser√° resolvida quando todos os dados estiverem dispon√≠veis
      return new Promise(resolve => {
        // Verifica se todos os dados do Firebase foram carregados
        const checkDataReady = () => {
          if (januaryData && februaryData && marchData && aprilData && mayData && juneData && julyData && augustData && septemberData && octoberData && novemberData && decemberData) {
            resolve();
          } else {
            // Se n√£o estiverem todos carregados, verifica novamente ap√≥s um curto intervalo
            setTimeout(checkDataReady, 100);
          }
        };
        checkDataReady();
      });
    }

    // Fun√ß√£o para exibir uma mensagem do bot no chatLog
    function displayBotMessage(message) {
      chatLog.innerHTML += `<div class="bot-message"><strong>Assistente:</strong> ${message}</div>`;
    }

    // Inicializar a biblioteca Materialize e adicionar evento de clique ao bot√£o
    document.addEventListener('DOMContentLoaded', function () {
      M.AutoInit(); // Inicializar Materialize
      // Obter o bot√£o pelo ID:
      const botButton = document.getElementById('bot-button');

      // Adicionar o evento de clique:
      botButton.addEventListener('click', sendMessage);

      document.getElementById('backButton').addEventListener('click', function () {
        window.history.back();
      });
      document.getElementById('nextButton').addEventListener('click', function () {
        window.history.back();
      });
    });

    // Fun√ß√µes para deslizamento de tela touch:
    var touchstartX = 0;
    var touchendX = 0;
    var gestureZone = 50; // A dist√¢ncia m√≠nima para considerar um deslizamento v√°lido

    document.addEventListener('touchstart', function (event) {
      touchstartX = event.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', function (event) {
      touchendX = event.changedTouches[0].screenX;
      handleGesture();
    });

    function handleGesture() {
      if (touchendX < touchstartX && Math.abs(touchendX - touchstartX) > gestureZone) {
        // Deslizamento para a esquerda
        window.history.back(); // Redireciona para a p√°gina anterior
      } else if (touchendX > touchstartX && Math.abs(touchendX - touchstartX) > gestureZone) {
        // Deslizamento para a direita
        window.history.back(); // Redireciona para a p√°gina anterior
      }
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>

</html>